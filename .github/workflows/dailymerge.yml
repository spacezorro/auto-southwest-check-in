name: Resync Upstream

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch: 
    inputs:
      branch:
        default: 'emoji-notify'
      upstream:
        description: 'upstream repo to merge to "jdholtz", "dmytrokoren"...'
        default: 'jdholtz'
      remote_branch:
        description: 'upstream branch to merge to "master", "develop", "fix-a-thing"...'
        default: 'master'
      commit_message:
        description: 'Commit message template (use {date} for date, e.g., Submodule changed {date})'
        default: 'Upstream changed {date}' 

jobs:
  resync-upstream:
    runs-on: ubuntu-latest
    env:
      BRANCH: ${{ github.event.inputs.branch }}
      UPSTREAM:  ${{ github.event.inputs.upstream }}
      REMOTE_BRANCH: ${{ github.event.inputs.remote_branch }}
      COMMIT_MESSAGE: ${{ github.event.inputs.commit_message }}
    steps:
      - name: Checkout 
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 
          ref: ${{ github.event.inputs.branch }}
          token: ${{ secrets.GHCR_PAT }}
          submodules: recursive 

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/$UPSTREAM/auto-southwest-check-in.git
          git fetch upstream

      - name: Set up Repo for merge
        run: |
          git checkout $BRANCH
          git checkout upstream/$REMOTE_BRANCH -- .github/workflows/docker.yml
        continue-on-error: true 

      - name: Merge upstream/master
        id: merge
        run: |
          git merge --squash upstream/master
          echo "merge_success=$?" >> $GITHUB_OUTPUT
          git checkout HEAD -- .github/workflows/docker.yml
        continue-on-error: true # Continue to notify on failure

      - name: Commit if Merge was successful
        if: steps.merge.outputs.merge_success == '0'
        run: |
          COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE" | sed "s/{date}/$(date -u +%Y-%m-%d)/g")
          git commit -m "$COMMIT_MESSAGE" || echo "No changes to commit"
        env:
<<<<<<< HEAD
          GITHUB_TOKEN: ${{ secrets.GHCR_PAT }}
=======
>>>>>>> a72034b (Fix Workflow)
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
          GIT_COMMITTER_NAME: "github-actions[bot]"
          GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"
        continue-on-error: true

      - name: Push merged changes
        if: steps.merge.outputs.merge_success == '0'
        run: |
          git push origin emoji-notify || echo "No changes to commit"
        env:
          GITHUB_TOKEN: ${{ secrets.GHCR_PAT }}
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
          GIT_COMMITTER_NAME: "github-actions[bot]"
          GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"

      - name: Notify on merge failure via Docker webhook
        if: steps.merge.outputs.merge_success != '0'
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"repository": "${{ github.repository }}", "message": "Failed to automerge due to conflicts"}' \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
        continue-on-error: true
